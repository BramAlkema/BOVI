import e from"elkjs/lib/elk.bundled.js";class t{constructor(){this.contexts=new Map}createContext(e){const t={flowId:e.id,nodeOutputs:{},activeTimers:new Set,userOverrides:{},startTime:0,aiButlerEnabled:!0,completed:!1};return this.contexts.set(e.id,t),t}getContext(e){return this.contexts.get(e)}updateContext(e,t){const o=this.contexts.get(e);o&&Object.assign(o,t)}removeContext(e){this.contexts.delete(e)}getActiveFlows(){return Array.from(this.contexts.keys()).filter(e=>{const t=this.contexts.get(e);return t&&!t.completed&&!t.error})}clear(){this.contexts.clear()}getContextValue(e,t){const o=t.split(".");let n=e;for(const e of o)n=n?.[e];return n}getPreviousNodeOutput(e,t){const o=Object.values(e.nodeOutputs);return o[o.length-1]?.[t]}storeNodeOutput(e,t,o){e.nodeOutputs[t]=o}setUserOverride(e,t){e.userOverrides[t]=!0}addActiveTimer(e,t){e.activeTimers.add(t)}removeActiveTimer(e,t){e.activeTimers.delete(t)}clearActiveTimers(e,t){t&&e.activeTimers.forEach(e=>t(e)),e.activeTimers.clear()}}var o;!function(e){e.BALANCED="B",e.OBLIGATED="O",e.VALUE="V",e.IMMEDIATE="I"}(o||(o={}));class n extends EventTarget{emit(e,t,o){const n=new CustomEvent(e,{detail:t,bubbles:o?.bubbles??!1,cancelable:o?.cancelable??!1});return"undefined"!=typeof window&&"localhost"===window.location.hostname&&console.log(`🚌 BOVI Event: ${e}`,t),this.dispatchEvent(n)}on(e,t,o){this.addEventListener(e,t,o)}off(e,t,o){this.removeEventListener(e,t,o)}once(e,t){this.addEventListener(e,t,{once:!0})}}const i=new n,s=i.emit.bind(i),r=i.on.bind(i);i.off.bind(i),i.once.bind(i);const a=new class{constructor(){this.logs=[],Object.keys({}).forEach(e=>{i.addEventListener(e,t=>{const o=t;this.logEvent(e,o.detail)})})}logEvent(e,t){const o={timestamp:Date.now(),event_type:e,flow:t.flow||"unknown",node:t.node,detail:{...t},user_agent:navigator.userAgent};this.logs.push(o),"undefined"!=typeof window&&window.indexedDB&&this.persistLog(o)}async persistLog(e){try{const t=indexedDB.open("bovi-audit",1);t.onsuccess=()=>{t.result.transaction(["logs"],"readwrite").objectStore("logs").add(e)}}catch(e){console.warn("Failed to persist audit log:",e)}}getLogs(e){let t=this.logs;return e?.flow&&(t=t.filter(t=>t.flow===e.flow)),e?.mode&&(t=t.filter(t=>t.event_type.startsWith(`${e.mode}.`))),e?.since&&(t=t.filter(t=>t.timestamp>=e.since)),t}export(){return JSON.stringify(this.logs,null,2)}clear(){this.logs=[]}};class l{constructor(){this.channel=new BroadcastChannel("bovi-flows"),Object.keys({}).forEach(e=>{i.addEventListener(e,t=>{const o=t;this.channel.postMessage({type:e,detail:o.detail,timestamp:Date.now()})})}),this.channel.addEventListener("message",e=>{const{type:t,detail:o}=e.data;o.__fromStudio||i.emit(t,{...o,__fromStudio:!0})})}close(){this.channel.close()}}"undefined"!=typeof window&&new l;const c=new class{constructor(){this.timers=new Map,this.idCounter=0}start(e){const t=`${e.flow}-${e.node}-${++this.idCounter}`,o=Date.now();s(`${e.mode}.default.started`,{flow:e.flow,node:e.node,timeout_s:e.timeout_s,action:e.action});const n=window.setTimeout(()=>{this.executeDefaultAction(t)},1e3*e.timeout_s),i=window.setInterval(()=>{const n=(Date.now()-o)/1e3,i=Math.max(0,e.timeout_s-n);if(s("ui.countdown.tick",{flow:e.flow,node:e.node,remaining:Math.ceil(i)}),i<=0){const e=this.timers.get(t);e?.intervalHandle&&clearInterval(e.intervalHandle)}},1e3),r={id:t,config:e,startTime:o,timeoutHandle:n,intervalHandle:i,cancelled:!1};return this.timers.set(t,r),t}cancel(e,t="user_action"){const o=this.timers.get(e);return!(!o||o.cancelled)&&(clearTimeout(o.timeoutHandle),o.intervalHandle&&clearInterval(o.intervalHandle),o.cancelled=!0,s(`${o.config.mode}.default.cancelled`,{flow:o.config.flow,node:o.config.node,reason:t}),!0)}executeDefaultAction(e){const t=this.timers.get(e);if(!t||t.cancelled)return;t.intervalHandle&&clearInterval(t.intervalHandle);const o=this.performAction(t.config.action,t.config);s(`${t.config.mode}.default.applied`,{flow:t.config.flow,node:t.config.node,action:t.config.action,result:o}),this.timers.delete(e)}performAction(e,t){switch(e){case"I.Fallback.high":return this.executeImmediateFallback("high",t);case"I.Fallback.usual":return this.executeImmediateFallback("usual",t);case"B.Fallback.fair":return this.executeBalancedFallback(t);case"O.Fallback.comply":return this.executeObligatedFallback(t);default:return console.warn(`Unknown action: ${e}`),{action:e,status:"unknown"}}}executeImmediateFallback(e,t){return{mode:"immediate",level:e,message:`Selected ${e} quality items for immediate consumption`,timestamp:Date.now()}}executeBalancedFallback(e){return{mode:"balanced",message:"Applied fair counter-offer calculation",calculation:"based on market rates and personal circumstances",timestamp:Date.now()}}executeObligatedFallback(e){return{mode:"obligated",message:"Complied with group/authority recommendation",authority:"collective decision",timestamp:Date.now()}}getActiveTimers(){return Array.from(this.timers.values()).filter(e=>!e.cancelled)}getRemainingTime(e){const t=this.timers.get(e);if(!t||t.cancelled)return 0;const o=(Date.now()-t.startTime)/1e3;return Math.max(0,t.config.timeout_s-o)}cleanup(){this.timers.forEach(e=>{this.cancel(e.id,"cleanup")}),this.timers.clear()}},d=(e,t)=>c.cancel(e,t);class u{constructor(e){this.contextManager=e}startNodeTimeout(e,t,o){const n=this.contextManager.getContext(t);if(!n)return;const[i]=e.type.split("."),s={flow:t,node:e.id,timeout_s:e.config.timeout_s,action:e.config.action,mode:i},r=(a=s,c.start(a));var a;this.contextManager.addActiveTimer(n,r),this.setupTimerEventHandlers(i,t,e.id,r,o)}cancelNodeTimeout(e,t,o="user_action"){const n=this.contextManager.getContext(e);if(!n)return;const i=Array.from(n.activeTimers)[0];i&&(d(i,o),this.contextManager.removeActiveTimer(n,i))}cancelAllTimers(e,t){const o=this.contextManager.getContext(e);o&&this.contextManager.clearActiveTimers(o,e=>{d(e,t)})}setupTimerEventHandlers(e,t,o,n,s){const r=this.contextManager.getContext(t);if(!r)return;const a=e=>{i.on(`${e}.applied`,e=>{if(e.detail?.flow===t&&e.detail?.node===o){const t={action_applied:!0,result:e.detail?.result||{},type:"timeout"};this.contextManager.removeActiveTimer(r,n),s(o,t)}}),i.on(`${e}.cancelled`,e=>{e.detail?.flow===t&&e.detail?.node===o&&(this.contextManager.removeActiveTimer(r,n),this.contextManager.setUserOverride(r,o))})};switch(e){case"I":a("I.default");break;case"B":a("B.default");break;case"O":a("O.default");break;case"V":a("V.default")}}}class h{constructor(e){this.contextManager=e}async executeNode(e,t){const[o,n]=e.type.split(".");switch(`${o}.${n}`){case"V.PDA":return this.executePDANode(e,t);case"V.Calculate":return this.executeCalculateNode(e,t);case"V.Assess":return this.executeAssessNode(e,t);case"I.Detect":return this.executeDetectNode(e,t);case"I.Default":case"B.Default":case"O.Default":return this.executeDefaultNode(e,t);case"B.Sweep":return this.executeSweepNode(e,t);case"B.Learn":return this.executeLearnNode(e,t);default:throw new Error(`Unknown node type: ${e.type}`)}}async executePDANode(e,t){const o=e.config?.items||[];let n=0,i=0,r=0;s("V.pda.started",{flow:t.flowId,node:e.id,items:o}),o.forEach(e=>{n+=e.price,i+=e.price*("groceries"===t.flowId?.86:1),r+=(e.price-e.usual)/e.usual});const a=r/o.length<-.02?"Great":r/o.length<.02?"OK":"Poor",l={nominal:n,real:i,quality:a};return s("V.pda.completed",{flow:t.flowId,node:e.id,...l}),l}async executeCalculateNode(e,t){const o=e.config?.formula||"sum",n=e.config?.inputs||[];let i=0;"sum"===o?i=n.reduce((e,t)=>e+t,0):"average"===o&&(i=n.reduce((e,t)=>e+t,0)/n.length);const r={result:i};return s("V.calculate.completed",{flow:t.flowId,node:e.id,result:i}),r}async executeAssessNode(e,t){const o=e.config?.threshold||.5,n=Math.random()>o,i={assessment:n,reason:n?"meets criteria":"below threshold"};return s("V.assess.completed",{flow:t.flowId,node:e.id,assessment:n}),i}async executeDetectNode(e,t){let o=!1,n=[];if((e.config?.triggers||[]).includes("shrink")){n=(this.contextManager.getPreviousNodeOutput(t,"items")||[]).filter(e=>e.shrink),o=n.length>0}const i={violation_detected:o,violation_type:o?"shrinkflation":null,affected_items:n};return o&&s("I.detect.violation",{flow:t.flowId,node:e.id,violation:i.violation_type||"unknown",affected:n}),i}async executeDefaultNode(e,t){return{action_applied:!0,result:{applied:!0,type:"immediate",action:e.config?.action||"default_action"}}}async executeSweepNode(e,t){const o=e.config?.kpis||{},n={};Object.entries(o).forEach(([e,o])=>{n[e]=this.calculateKPI(o,t)});const i={kpis:n};return s("B.sweep.updated",{flow:t.flowId,node:e.id,kpis:n}),i}async executeLearnNode(e,t){const o=e.config?.episode_id,n=e.config?.priority||"medium";return o&&(console.log(`Queuing episode ${o} with priority ${n}`),s("B.learn.triggered",{flow:t.flowId,node:e.id,episode:o,priority:n})),{episode_queued:!!o}}calculateKPI(e,t){if(e.startsWith("last(")){const o=e.slice(5,-1);return this.contextManager.getContextValue(t,o)}return e.startsWith("count(")?Object.keys(t.nodeOutputs).length:e.startsWith("sum(")?Object.values(t.nodeOutputs).reduce((e,t)=>e+("number"==typeof t?t:0),0):null}}class g{constructor(){this.flowSpecs=new Map,this.contextManager=new t,this.timerService=new u(this.contextManager),this.nodeExecutor=new h(this.contextManager)}async loadFlow(e){this.flowSpecs.set(e.id,e),this.contextManager.createContext(e)}startFlow(e,t){const o=this.contextManager.getContext(e),n=this.flowSpecs.get(e);o&&n?(this.contextManager.updateContext(e,{startTime:Date.now(),currentNode:this.getStartNode(n)?.id,completed:!1,error:void 0}),t&&Object.assign(n.context,t),s("flow.started",{flow:e,context:n.context}),o.currentNode?this.executeNode(o.currentNode,e):this.completeFlow(e)):console.error(`Flow ${e} not found or not loaded`)}async executeNode(e,t){const o=this.contextManager.getContext(t),n=this.flowSpecs.get(t),i=n?.nodes.find(t=>t.id===e);if(o&&n&&i)try{if(this.shouldUseTimeout(i,o))return void this.timerService.startNodeTimeout(i,t,(e,n)=>{this.contextManager.storeNodeOutput(o,e,n),this.moveToNextNode(t,e)});const n=await this.nodeExecutor.executeNode(i,o);this.contextManager.storeNodeOutput(o,e,n),this.moveToNextNode(t,e)}catch(o){this.errorFlow(t,o,e)}else this.errorFlow(t,new Error(`Node ${e} not found`),e)}moveToNextNode(e,t){const o=this.contextManager.getContext(e),n=this.flowSpecs.get(e);if(!o||!n)return;const i=this.getNextNode(n,t,o);i?(this.contextManager.updateContext(e,{currentNode:i.id}),this.executeNode(i.id,e)):this.completeFlow(e)}completeFlow(e){const t=this.contextManager.getContext(e);t&&(this.contextManager.updateContext(e,{completed:!0,currentNode:void 0}),this.timerService.cancelAllTimers(e,"flow_completed"),s("flow.completed",{flow:e,outputs:t.nodeOutputs}))}errorFlow(e,t,o){this.contextManager.getContext(e)&&(this.contextManager.updateContext(e,{error:t,completed:!0}),this.timerService.cancelAllTimers(e,"flow_error"),s("flow.error",{flow:e,error:t,node:o}))}cancelTimeout(e,t,o="user_action"){this.timerService.cancelNodeTimeout(e,t,o)}overrideAction(e,t,o){const n=this.contextManager.getContext(e);if(!n)return;this.timerService.cancelNodeTimeout(e,t,"user_override"),s("ui.action.override",{flow:e,node:t,action:o});const i={action_applied:!0,result:{applied:!0,type:"user_override",action:o},type:"override"};this.contextManager.storeNodeOutput(n,t,i),this.contextManager.setUserOverride(n,t),this.moveToNextNode(e,t)}stopFlow(e){this.contextManager.getContext(e)&&(this.timerService.cancelAllTimers(e,"flow_stopped"),this.contextManager.removeContext(e))}getFlowState(e){const t=this.contextManager.getContext(e);return t?t.error?"error":t.completed?"completed":t.currentNode?"running":"idle":"idle"}getActiveFlows(){return this.contextManager.getActiveFlows()}shouldUseTimeout(e,t){return!(!e.config?.timeout_s||!t.aiButlerEnabled)}getStartNode(e){const t=new Set(e.edges.map(e=>e.to));return e.nodes.find(e=>!t.has(e.id))||null}getNextNode(e,t,o){const n=e.edges.filter(e=>e.from===t);for(const t of n)if(this.evaluateCondition(t.condition,o))return e.nodes.find(e=>e.id===t.to)||null;return null}evaluateCondition(e,t){if("always"===e)return!0;if("never"===e)return!1;try{const o=e.replace(/\{\{(.*?)\}\}/g,(e,o)=>String(this.contextManager.getContextValue(t,o)||"null"));return new Function("return "+o)()}catch{return!1}}}const w=new g;var p=Object.freeze({__proto__:null,FlowContextManager:t,FlowRunner:g,FlowTimerService:u,NodeExecutorService:h,flowRunner:w});class f{constructor(){this.flowSpecs=new Map}async loadFlowSpecs(e=["groceries","rent","energy"]){for(const t of e)try{const e=await fetch(`/flows/${t}.json`),o=await e.json();this.flowSpecs.set(t,o),await w.loadFlow(o),console.log(`📋 Loaded flow: ${t}`)}catch(e){console.warn(`Failed to load flow ${t}:`,e)}}getFlowSpec(e){return this.flowSpecs.get(e)}getAllFlowSpecs(){const e={};return this.flowSpecs.forEach((t,o)=>{e[o]=t}),e}isFlowLoaded(e){return this.flowSpecs.has(e)}async reloadFlow(e){try{const t=await fetch(`/flows/${e}.json`),o=await t.json();this.flowSpecs.set(e,o),await w.loadFlow(o),console.log(`🔄 Reloaded flow: ${e}`)}catch(t){throw console.error(`Failed to reload flow ${e}:`,t),t}}}const m=new f,y={B:"#4cc9f0",O:"#ff6b6b",V:"#a1ffb5",I:"#ffd166"};class v{constructor(e){if(this.flowSpec=null,this.layout=null,this.activeNodes=new Set,this.activeEdges=new Set,this.container=document.getElementById(e),!this.container)throw new Error(`Container ${e} not found`);this.setupEventListeners(),this.createSVG()}setupEventListeners(){r("V.pda.started",e=>this.highlightNode(e.detail.node)),r("V.pda.completed",e=>this.unhighlightNode(e.detail.node)),r("I.detect.violation",e=>this.highlightNode(e.detail.node)),r("I.default.started",e=>this.highlightNode(e.detail.node,"pulsing")),r("I.default.applied",e=>{this.unhighlightNode(e.detail.node),this.flashNode(e.detail.node,"success")}),r("I.default.cancelled",e=>{this.unhighlightNode(e.detail.node),this.flashNode(e.detail.node,"cancelled")}),r("B.default.started",e=>this.highlightNode(e.detail.node,"pulsing")),r("B.default.applied",e=>{this.unhighlightNode(e.detail.node),this.flashNode(e.detail.node,"success")}),r("B.sweep.updated",e=>this.flashNode(e.detail.node,"kpi-update")),r("O.default.started",e=>this.highlightNode(e.detail.node,"pulsing")),r("O.default.applied",e=>{this.unhighlightNode(e.detail.node),this.flashNode(e.detail.node,"success")}),r("flow.started",e=>this.showFlowStart(e.detail.flow)),r("flow.completed",e=>this.showFlowComplete(e.detail.flow)),r("flow.error",e=>this.showFlowError(e.detail.flow,e.detail.node)),r("ui.countdown.tick",e=>this.updateCountdown(e.detail.node,e.detail.remaining))}createSVG(){this.svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svg.setAttribute("width","100%"),this.svg.setAttribute("height","400"),this.svg.setAttribute("viewBox","0 0 800 400"),this.svg.style.background="rgba(255,255,255,0.02)",this.svg.style.borderRadius="12px",this.svg.style.border="1px solid rgba(255,255,255,0.08)";const e=document.createElementNS("http://www.w3.org/2000/svg","style");e.textContent="\n      .flow-node {\n        transition: all 0.3s ease;\n        cursor: pointer;\n      }\n      \n      .flow-node:hover {\n        transform: scale(1.05);\n      }\n      \n      .flow-node.active {\n        filter: drop-shadow(0 0 8px currentColor);\n      }\n      \n      .flow-node.pulsing {\n        animation: pulse 2s infinite;\n      }\n      \n      .flow-edge {\n        transition: all 0.3s ease;\n      }\n      \n      .flow-edge.active {\n        stroke-width: 3;\n        filter: drop-shadow(0 0 4px currentColor);\n      }\n      \n      .node-text {\n        font-family: ui-sans-serif, system-ui;\n        font-size: 12px;\n        fill: #e7eef9;\n        text-anchor: middle;\n        dominant-baseline: central;\n      }\n      \n      .node-badge {\n        font-family: ui-sans-serif, system-ui;\n        font-size: 10px;\n        font-weight: 600;\n        fill: #000;\n        text-anchor: middle;\n        dominant-baseline: central;\n      }\n      \n      .countdown-text {\n        font-family: ui-mono, monospace;\n        font-size: 10px;\n        fill: #ffd166;\n        text-anchor: middle;\n        dominant-baseline: central;\n      }\n      \n      @keyframes pulse {\n        0%, 100% { opacity: 1; }\n        50% { opacity: 0.6; }\n      }\n      \n      .flash-success {\n        animation: flashSuccess 1s ease;\n      }\n      \n      .flash-cancelled {\n        animation: flashCancelled 1s ease;\n      }\n      \n      .flash-kpi {\n        animation: flashKpi 0.5s ease;\n      }\n      \n      @keyframes flashSuccess {\n        0% { fill: currentColor; }\n        50% { fill: #7cf08a; }\n        100% { fill: currentColor; }\n      }\n      \n      @keyframes flashCancelled {\n        0% { fill: currentColor; }\n        50% { fill: #ff6b6b; }\n        100% { fill: currentColor; }\n      }\n      \n      @keyframes flashKpi {\n        0% { fill: currentColor; }\n        50% { fill: #4cc9f0; }\n        100% { fill: currentColor; }\n      }\n    ",this.svg.appendChild(e),this.container.appendChild(this.svg)}async renderFlow(e){this.flowSpec=e,this.layout=await this.calculateLayout(e),this.render()}async calculateLayout(t){const o=new e,n={id:"root",layoutOptions:{"elk.algorithm":"layered","elk.direction":"DOWN","elk.spacing.nodeNode":"50","elk.layered.spacing.nodeNodeBetweenLayers":"80","elk.spacing.edgeNode":"30"},children:t.nodes.map(e=>({id:e.id,width:120,height:60,labels:[{text:e.label}]})),edges:t.edges.map(e=>({id:`${e.from}-${e.to}`,sources:[e.from],targets:[e.to]}))},i=await o.layout(n);return{nodes:i.children?.map(e=>({id:e.id,x:e.x||0,y:e.y||0,width:e.width||120,height:e.height||60}))||[],edges:i.edges?.map(e=>{const t=e.sections||[],o=t.length>0?[{x:t[0].startPoint.x,y:t[0].startPoint.y},{x:t[0].endPoint.x,y:t[0].endPoint.y}]:[{x:0,y:0},{x:0,y:0}];return{from:e.sources?.[0]||"",to:e.targets?.[0]||"",points:o}})||[],width:Math.max(800,(i.width||800)+100),height:Math.max(400,(i.height||400)+100)}}render(){if(!this.layout||!this.flowSpec)return;Array.from(this.svg.children).forEach(e=>{"style"!==e.tagName&&"defs"!==e.tagName&&this.svg.removeChild(e)}),this.svg.setAttribute("viewBox",`0 0 ${this.layout.width} ${this.layout.height}`),this.svg.setAttribute("height",Math.min(600,this.layout.height).toString()),this.layout.edges.forEach(e=>{this.renderEdge(e)}),this.layout.nodes.forEach(e=>{const t=this.flowSpec.nodes.find(t=>t.id===e.id);this.renderNode(e,t)})}renderEdge(e){const t=document.createElementNS("http://www.w3.org/2000/svg","g");t.setAttribute("class","flow-edge"),t.setAttribute("data-edge",`${e.from}-${e.to}`);const o=document.createElementNS("http://www.w3.org/2000/svg","path"),n=`M ${e.points[0].x} ${e.points[0].y} L ${e.points[1].x} ${e.points[1].y}`;if(o.setAttribute("d",n),o.setAttribute("stroke","rgba(255,255,255,0.3)"),o.setAttribute("stroke-width","2"),o.setAttribute("fill","none"),o.setAttribute("marker-end","url(#arrowhead)"),!this.svg.querySelector("#arrowhead")){const e=document.createElementNS("http://www.w3.org/2000/svg","defs"),t=document.createElementNS("http://www.w3.org/2000/svg","marker");t.setAttribute("id","arrowhead"),t.setAttribute("markerWidth","10"),t.setAttribute("markerHeight","7"),t.setAttribute("refX","9"),t.setAttribute("refY","3.5"),t.setAttribute("orient","auto");const o=document.createElementNS("http://www.w3.org/2000/svg","polygon");o.setAttribute("points","0 0, 10 3.5, 0 7"),o.setAttribute("fill","rgba(255,255,255,0.3)"),t.appendChild(o),e.appendChild(t),this.svg.insertBefore(e,this.svg.firstChild?.nextSibling||null)}t.appendChild(o),this.svg.appendChild(t)}renderNode(e,t){const o=document.createElementNS("http://www.w3.org/2000/svg","g");o.setAttribute("class","flow-node"),o.setAttribute("data-node",t.id),o.setAttribute("data-type",t.type);const[n]=t.type.split("."),i=y[n]||"#7a8798",s=document.createElementNS("http://www.w3.org/2000/svg","rect");s.setAttribute("x",e.x.toString()),s.setAttribute("y",e.y.toString()),s.setAttribute("width",e.width.toString()),s.setAttribute("height",e.height.toString()),s.setAttribute("rx","8"),s.setAttribute("fill","rgba(17,24,35,0.9)"),s.setAttribute("stroke",i),s.setAttribute("stroke-width","2");const r=document.createElementNS("http://www.w3.org/2000/svg","rect");r.setAttribute("x",(e.x+8).toString()),r.setAttribute("y",(e.y+8).toString()),r.setAttribute("width","16"),r.setAttribute("height","16"),r.setAttribute("rx","3"),r.setAttribute("fill",i);const a=document.createElementNS("http://www.w3.org/2000/svg","text");a.setAttribute("class","node-badge"),a.setAttribute("x",(e.x+16).toString()),a.setAttribute("y",(e.y+16).toString()),a.textContent=n;const l=document.createElementNS("http://www.w3.org/2000/svg","text");l.setAttribute("class","node-text"),l.setAttribute("x",(e.x+e.width/2).toString()),l.setAttribute("y",(e.y+e.height/2+4).toString()),l.textContent=this.truncateText(t.label,14);const c=document.createElementNS("http://www.w3.org/2000/svg","text");c.setAttribute("class","countdown-text"),c.setAttribute("x",(e.x+e.width/2).toString()),c.setAttribute("y",(e.y+e.height-8).toString()),c.setAttribute("data-countdown",t.id),c.style.display="none",o.addEventListener("click",()=>{this.showNodeDetails(t)}),o.appendChild(s),o.appendChild(r),o.appendChild(a),o.appendChild(l),o.appendChild(c),this.svg.appendChild(o)}truncateText(e,t){return e.length<=t?e:e.slice(0,t-1)+"…"}highlightNode(e,t="active"){const o=this.svg.querySelector(`[data-node="${e}"]`);o&&(o.classList.add(t),this.activeNodes.add(e))}unhighlightNode(e){const t=this.svg.querySelector(`[data-node="${e}"]`);t&&(t.classList.remove("active","pulsing"),this.activeNodes.delete(e))}flashNode(e,t){const o=this.svg.querySelector(`[data-node="${e}"]`),n=o?.querySelector("rect");n&&(n.classList.add(`flash-${t}`),setTimeout(()=>{n.classList.remove(`flash-${t}`)},1e3))}updateCountdown(e,t){const o=this.svg.querySelector(`[data-countdown="${e}"]`);o&&(o.textContent=`${t}s`,o.style.display=t>0?"block":"none")}showFlowStart(e){this.svg.style.border="2px solid #4cc9f0",setTimeout(()=>{this.svg.style.border="1px solid rgba(255,255,255,0.08)"},1e3)}showFlowComplete(e){this.svg.style.border="2px solid #7cf08a",setTimeout(()=>{this.svg.style.border="1px solid rgba(255,255,255,0.08)"},2e3)}showFlowError(e,t){this.svg.style.border="2px solid #ff6b6b",t&&this.flashNode(t,"cancelled"),setTimeout(()=>{this.svg.style.border="1px solid rgba(255,255,255,0.08)"},3e3)}showNodeDetails(e){const t={id:e.id,type:e.type,label:e.label,description:e.description,config:e.config};console.log("Node details:",t),window.dispatchEvent(new CustomEvent("ui.node.selected",{detail:{nodeId:e.id,details:t}}))}clear(){this.activeNodes.clear(),this.activeEdges.clear(),this.svg.querySelectorAll(".flow-node").forEach(e=>{e.classList.remove("active","pulsing")}),this.svg.querySelectorAll(".flow-edge").forEach(e=>{e.classList.remove("active")}),this.svg.querySelectorAll(".countdown-text").forEach(e=>{e.style.display="none"})}}class b{constructor(){this.studios=new Map}initializeStudios(e){Object.entries(e).forEach(([e,t])=>{this.createStudioForFlow(e,t)})}createStudioForFlow(e,t){let o=document.getElementById(`${e}Studio`);if(!o){const t=document.querySelector(`#${e} .panel:last-child`);if(t){const n=document.createElement("div");n.innerHTML=`\n          <h3>Flow Visualization</h3>\n          <div id="${e}Studio" class="studio-container"></div>\n        `,t.appendChild(n),o=document.getElementById(`${e}Studio`)}}if(o){const o=new v(`${e}Studio`);o.renderFlow(t).catch(console.error),this.studios.set(e,o),console.log(`🎨 Studio created for ${e}`)}}getStudio(e){return this.studios.get(e)}getAllStudios(){const e={};return this.studios.forEach((t,o)=>{e[o]=t}),e}async updateStudio(e,t){const o=this.studios.get(e);o&&(await o.renderFlow(t),console.log(`🔄 Updated studio for ${e}`))}removeStudio(e){if(this.studios.get(e)){const t=document.getElementById(`${e}Studio`);t&&t.remove(),this.studios.delete(e),console.log(`🗑️ Removed studio for ${e}`)}}clearAll(){this.studios.forEach((e,t)=>{this.removeStudio(t)})}}const x=new b;class S{constructor(){this.flowSpecs={}}initialize(e){this.flowSpecs=e,this.integrateGroceries(),this.integrateRent(),this.integrateEnergy(),console.log("🔌 UI bridge initialized")}integrateGroceries(){const e=document.getElementById("scanBtn");e&&e.addEventListener("click",()=>{s("V.pda.started",{flow:"groceries",node:"scan_basket",items:this.flowSpecs.groceries?.nodes.find(e=>"scan_basket"===e.id)?.config?.items||[]}),w.startFlow("groceries")});const t=document.getElementById("applySwap"),o=document.getElementById("cancelSwap");t&&t.addEventListener("click",()=>{w.overrideAction("groceries","suggest_swap","apply")}),o&&o.addEventListener("click",()=>{w.cancelTimeout("groceries","suggest_swap","user_cancelled")}),r("I.default.applied",e=>{"groceries"===e.detail.flow&&this.updateGroceriesKPIs(e.detail)})}integrateRent(){["rentCurrent","rentProposed","rentIndex"].forEach(e=>{const t=document.getElementById(e);t&&t.addEventListener("input",()=>{const e={current_rent:+document.getElementById("rentCurrent").value,proposed_increase:+document.getElementById("rentProposed").value,personal_index:+document.getElementById("rentIndex").value};s("B.calculate.started",{flow:"rent",node:"calculate_fair_counter",context:e})})});const e=document.getElementById("rentSubmit"),t=document.getElementById("rentCancel");e&&e.addEventListener("click",()=>{w.overrideAction("rent","submit_counter","apply")}),t&&t.addEventListener("click",()=>{w.cancelTimeout("rent","submit_counter","user_cancelled")})}integrateEnergy(){["tariff","baseline"].forEach(e=>{const t=document.getElementById(e);t&&t.addEventListener("input",()=>{const e={current_tariff:+document.getElementById("tariff").value,cohort_baseline:+document.getElementById("baseline").value,enrollment_deadline:document.getElementById("deadline").value};s("V.calculate.started",{flow:"energy",node:"calculate_excess",context:e})})});const e=document.getElementById("energyEnrol"),t=document.getElementById("energyCancel");e&&e.addEventListener("click",()=>{w.overrideAction("energy","enroll_in_cohort","apply")}),t&&t.addEventListener("click",()=>{w.cancelTimeout("energy","enroll_in_cohort","user_cancelled")})}updateGroceriesKPIs(e){const t=document.getElementById("defaultsKPI");if(t){const e=parseInt(t.textContent||"0");t.textContent=(e+1).toString()}if(e.result?.quality){const t=document.getElementById("dqKPI"),o=document.getElementById("dqChip");t&&(t.textContent=e.result.quality),o&&(o.textContent="Groceries")}}updateFlowSpecs(e){this.flowSpecs=e}}const E=new S;class I{constructor(){this.aiButlerEnabled=!0}initialize(){this.setupAIButlerToggle(),this.setupCountdownDisplays(),this.setupToastNotifications(),console.log("🤖 AI Butler manager initialized")}setupAIButlerToggle(){const e=document.getElementById("toggleAI"),t=document.getElementById("aiState");e&&t&&e.addEventListener("click",()=>{this.aiButlerEnabled=!this.aiButlerEnabled,t.textContent=this.aiButlerEnabled?"ON":"OFF",s("ui.ai_butler.toggled",{enabled:this.aiButlerEnabled});w.getActiveFlows().forEach(e=>{console.log(`AI Butler ${this.aiButlerEnabled?"enabled":"disabled"} for flow: ${e}`)})})}setupCountdownDisplays(){r("ui.countdown.tick",e=>{this.updateCountdownDisplays(e.detail.flow,e.detail.node,e.detail.remaining)}),r("I.default.applied",e=>{this.clearCountdownDisplay(e.detail.flow,e.detail.node)}),r("B.default.applied",e=>{this.clearCountdownDisplay(e.detail.flow,e.detail.node)}),r("O.default.applied",e=>{this.clearCountdownDisplay(e.detail.flow,e.detail.node)})}setupToastNotifications(){const e=document.getElementById("toast");if(!e)return;const t=t=>{e.textContent=t,e.classList.add("show"),setTimeout(()=>{e.classList.remove("show")},2400)};r("I.default.applied",e=>{t(`✅ ${e.detail.action} applied automatically`)}),r("B.default.applied",()=>{t("⚖️ Fair counter-offer submitted")}),r("O.default.applied",()=>{t("👥 Enrolled in collective action")}),r("flow.error",e=>{t(`❌ Error in ${e.detail.flow} flow`)})}updateCountdownDisplays(e,t,o){if([`${e}Countdown`,`${e}-countdown`,`${t}-countdown`,"countdown"].forEach(e=>{const t=document.getElementById(e);t&&(this.aiButlerEnabled&&o>0?(t.textContent=`Auto-apply in ${o}s`,t.style.display="block"):this.aiButlerEnabled?t.style.display="none":(t.textContent="AI Butler is OFF",t.style.display="block"))}),"groceries"===e&&"suggest_swap"===t){const e=document.querySelector(".countdown");e&&(e.textContent=this.aiButlerEnabled?`${o}s`:"OFF")}}clearCountdownDisplay(e,t){[`${e}Countdown`,`${e}-countdown`,`${t}-countdown`,"countdown"].forEach(e=>{const t=document.getElementById(e);t&&(t.style.display="none",t.textContent="")});document.querySelectorAll(".countdown").forEach(e=>{e.textContent="",e.style.display="none"})}isEnabled(){return this.aiButlerEnabled}setEnabled(e){this.aiButlerEnabled=e,s("ui.ai_butler.toggled",{enabled:e})}toggle(){this.setEnabled(!this.aiButlerEnabled)}}const A=new I;class N{showAuditTrail(){const e=a.getLogs(),t=window.open("","_blank","width=800,height=600");t&&t.document.write(`\n        <html>\n          <head>\n            <title>BOVI Audit Trail</title>\n            <style>\n              body { \n                font-family: monospace; \n                margin: 20px; \n                background: #0b0f14; \n                color: #e7eef9; \n              }\n              .log-entry { \n                margin: 10px 0; \n                padding: 8px; \n                background: rgba(255,255,255,0.03); \n                border-radius: 4px; \n              }\n              .timestamp { color: #7a8798; }\n              .event-type { color: #4cc9f0; font-weight: bold; }\n              .flow { color: #a1ffb5; }\n              .node { color: #ffd166; }\n              .controls {\n                margin-bottom: 20px;\n                padding: 10px;\n                background: rgba(255,255,255,0.05);\n                border-radius: 4px;\n              }\n              .btn {\n                background: #4cc9f0;\n                color: #0b0f14;\n                border: none;\n                padding: 8px 16px;\n                margin-right: 10px;\n                border-radius: 4px;\n                cursor: pointer;\n              }\n              .btn:hover {\n                background: #7dd3fc;\n              }\n            </style>\n          </head>\n          <body>\n            <h1>BOVI Audit Trail</h1>\n            <div class="controls">\n              <button class="btn" onclick="window.print()">Print</button>\n              <button class="btn" onclick="exportLogs()">Export JSON</button>\n              <button class="btn" onclick="clearLogs()">Clear</button>\n            </div>\n            <div id="logs">\n              ${e.map(e=>`\n                <div class="log-entry">\n                  <span class="timestamp">${new Date(e.timestamp).toISOString()}</span>\n                  <span class="event-type">${e.event_type}</span>\n                  <span class="flow">flow:${e.flow}</span>\n                  ${e.node?`<span class="node">node:${e.node}</span>`:""}\n                  <pre>${JSON.stringify(e.detail,null,2)}</pre>\n                </div>\n              `).join("")}\n            </div>\n            <script>\n              function exportLogs() {\n                const logs = ${JSON.stringify(e)};\n                const blob = new Blob([JSON.stringify(logs, null, 2)], {\n                  type: 'application/json'\n                });\n                const url = URL.createObjectURL(blob);\n                const a = document.createElement('a');\n                a.href = url;\n                a.download = 'bovi-audit-trail.json';\n                a.click();\n                URL.revokeObjectURL(url);\n              }\n              \n              function clearLogs() {\n                if (confirm('Are you sure you want to clear all logs?')) {\n                  // This would need to be implemented to communicate back to parent\n                  alert('Clear logs functionality needs parent window integration');\n                }\n              }\n            <\/script>\n          </body>\n        </html>\n      `)}exportLogs(){const e=a.getLogs(),t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),o=URL.createObjectURL(t),n=document.createElement("a");n.href=o,n.download=`bovi-audit-trail-${Date.now()}.json`,n.click(),URL.revokeObjectURL(o)}getLogsSummary(){const e=a.getLogs();if(0===e.length)return{totalEvents:0,eventTypes:{},flows:{},timeRange:null};const t={},o={};e.forEach(e=>{t[e.event_type]=(t[e.event_type]||0)+1,o[e.flow]=(o[e.flow]||0)+1});const n=e.map(e=>e.timestamp).sort();return{totalEvents:e.length,eventTypes:t,flows:o,timeRange:{start:new Date(n[0]).toISOString(),end:new Date(n[n.length-1]).toISOString()}}}clearLogs(){a.clear(),console.log("🗑️ Audit logs cleared")}}const C=new N;async function k(){const e=new Date;return{period:`${new Date(e.getTime()-6048e5).toISOString().split("T")[0]} to ${e.toISOString().split("T")[0]}`,highlights:["Personal inflation ran 0.15% higher than official CPI","Grocery basket increased 2.3% week-over-week","Energy costs stable despite cold weather"],netChange:-12.45,recommendations:["Consider switching to Tesco own-brand cereals (saving: £3.20/week)","Your mortgage rate beats inflation by 1.2% - good position","Council tax increase kicks in next month - budget +£8/week"]}}async function B(){return.0347}async function O(){return.0332}localStorage.getItem("bovi.activeRuler");class T{initialize(){this.startWeeklyDigest(),this.startStormModeMonitoring(),console.log("📢 Notification service initialized")}startWeeklyDigest(){const e=localStorage.getItem("bovi.lastWeeklyDigest");(e?(Date.now()-parseInt(e))/6048e5:999)>=1&&setTimeout(async()=>{try{const e=await k();this.showDigestModal(e),localStorage.setItem("bovi.lastWeeklyDigest",Date.now().toString())}catch(e){console.error("Weekly digest error:",e)}},5e3),this.digestInterval=window.setInterval(()=>{this.checkForWeeklyDigest()},864e5)}startStormModeMonitoring(){this.stormMonitoringInterval=window.setInterval(async()=>{try{const e=await async function(){const e=.03;return[{id:"bovi-local",name:"BOVI Local LTS",method:"Personal basket tracking",lastUpdated:(new Date).toISOString(),bpDrift:Math.round(1e4*(await B()-e))},{id:"bovi-cohort",name:"BOVI Cohort LTS",method:"Community aggregated",lastUpdated:(new Date).toISOString(),bpDrift:Math.round(1e4*(await O()-e))},{id:"ons-cpi",name:"ONS Official CPI",method:"Government published",lastUpdated:"2024-01-15T09:30:00Z",bpDrift:Math.round(20.000000000000018)},{id:"truflation",name:"Truflation Real-time",method:"Blockchain oracle",lastUpdated:(new Date).toISOString(),bpDrift:Math.round(-14.999999999999979)}]}();if((e.find(e=>"bovi-local"===e.id)?.bpDrift||0)>500){JSON.parse(localStorage.getItem("bovi.stormProfiles")||"[]").length>0&&!localStorage.getItem("bovi.stormMode.active")&&this.showStormModeAlert()}}catch(e){console.warn("Storm mode monitoring error:",e)}},3e5)}async checkForWeeklyDigest(){const e=localStorage.getItem("bovi.lastWeeklyDigest");if((e?(Date.now()-parseInt(e))/6048e5:999)>=1)try{const e=await k();this.showDigestModal(e),localStorage.setItem("bovi.lastWeeklyDigest",Date.now().toString())}catch(e){console.error("Weekly digest error:",e)}}showDigestModal(e){const t=new CustomEvent("bovi.showDigest",{detail:e});window.dispatchEvent(t),setTimeout(()=>{t.defaultPrevented||(console.log("Weekly Digest:",e),this.showNotification("📊 Weekly digest available - check console for details"))},100)}showStormModeAlert(){this.showNotification("⛈️ High inflation detected! Consider activating Storm Mode.","error")}showNotification(e,t="info"){const o=document.createElement("div");o.className=`notification ${t}`,o.textContent=e,Object.assign(o.style,{position:"fixed",top:"20px",right:"20px",padding:"12px 20px",backgroundColor:"error"===t?"#dc2626":"success"===t?"#059669":"#2563eb",color:"white",borderRadius:"6px",boxShadow:"0 10px 15px -3px rgba(0, 0, 0, 0.1)",zIndex:"9999",fontFamily:"system-ui, sans-serif",fontSize:"14px",maxWidth:"300px",wordWrap:"break-word"}),document.body.appendChild(o),setTimeout(()=>{o.remove()},5e3)}stop(){this.digestInterval&&(clearInterval(this.digestInterval),this.digestInterval=void 0),this.stormMonitoringInterval&&(clearInterval(this.stormMonitoringInterval),this.stormMonitoringInterval=void 0),console.log("📢 Notification service stopped")}restart(){this.stop(),this.initialize()}}const M=new T;class ${constructor(){this.initialized=!1}async initialize(){if(this.initialized)console.warn("BOVI hybrid system already initialized");else try{console.log("🚀 Initializing BOVI hybrid system..."),await m.loadFlowSpecs();const e=m.getAllFlowSpecs();x.initializeStudios(e),E.initialize(e),A.initialize(),M.initialize(),this.initialized=!0,console.log("✅ BOVI hybrid system initialized successfully")}catch(e){throw console.error("❌ Failed to initialize BOVI hybrid system:",e),e}}async shutdown(){if(this.initialized)try{console.log("🔄 Shutting down BOVI hybrid system..."),M.stop(),x.clearAll(),this.initialized=!1,console.log("✅ BOVI hybrid system shutdown complete")}catch(e){throw console.error("❌ Error during hybrid system shutdown:",e),e}}async restart(){await this.shutdown(),await this.initialize()}getStatus(){const e=m.getAllFlowSpecs(),t=x.getAllStudios();return{initialized:this.initialized,flowsLoaded:Object.keys(e).length,studiosActive:Object.keys(t).length,aiButlerEnabled:A.isEnabled()}}getComponents(){return{flowSpecs:m.getAllFlowSpecs(),studios:x.getAllStudios()}}showAuditTrail(){C.showAuditTrail()}exportAuditLogs(){C.exportLogs()}showNotification(e,t){M.showNotification(e,t)}}const F=new $,L=()=>{const{auditTrail:e}=require("./audit-trail.js");e.showAuditTrail()};var D=Object.freeze({__proto__:null,AIButlerManagerService:I,AuditTrailService:N,FlowLoaderService:f,HybridSystemOrchestrator:$,NotificationService:T,StudioManagerService:b,UIBridgeService:S,aiButlerManager:A,auditTrail:C,flowLoader:m,hybridOrchestrator:F,notificationService:M,showAuditTrail:L,studioManager:x,uiBridge:E});const _=async()=>{const{hybridOrchestrator:e}=await Promise.resolve().then(function(){return D});return e.initialize()};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",_):_();const z=(await Promise.resolve().then(function(){return p})).flowRunner,V={},j={},P=!0;export{I as AIButlerManagerService,N as AuditTrailService,f as FlowLoaderService,$ as HybridSystemOrchestrator,T as NotificationService,b as StudioManagerService,S as UIBridgeService,P as aiButlerEnabled,A as aiButlerManager,C as auditTrail,m as flowLoader,z as flowRunner,V as flowSpecs,F as hybridOrchestrator,_ as initBoviSystem,M as notificationService,L as showAuditTrail,x as studioManager,j as studios,E as uiBridge};
